name: "Release Stable"

on:
  workflow_dispatch:
    inputs:
      beta_tag:
        description: "Beta tag to promote (e.g., v1.4.15-beta.3)"
        required: true
        type: string
      sync_main:
        description: "Sync main branch with develop"
        required: false
        type: boolean
        default: true

concurrency:
  group: release-stable
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  # =============================================================================
  # Validate beta release
  # =============================================================================
  validate:
    name: "Validate"
    runs-on: ubuntu-latest
    outputs:
      beta_version: ${{ steps.parse.outputs.beta_version }}
      stable_version: ${{ steps.parse.outputs.stable_version }}
      release_id: ${{ steps.check.outputs.release_id }}
    steps:
      - name: "Parse versions"
        id: parse
        run: |
          BETA_TAG="${{ inputs.beta_tag }}"

          # Remove 'v' prefix if present
          BETA_VERSION="${BETA_TAG#v}"

          # Validate format: X.Y.Z-beta.N
          if ! [[ "$BETA_VERSION" =~ ^([0-9]+\.[0-9]+\.[0-9]+)-beta\.([0-9]+)$ ]]; then
            echo "::error::Invalid beta tag format. Expected: vX.Y.Z-beta.N"
            exit 1
          fi

          STABLE_VERSION="${BASH_REMATCH[1]}"

          echo "beta_version=$BETA_VERSION" >> $GITHUB_OUTPUT
          echo "stable_version=$STABLE_VERSION" >> $GITHUB_OUTPUT
          echo "Beta: $BETA_VERSION -> Stable: $STABLE_VERSION"

      - name: "Check beta release exists"
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BETA_TAG="v${{ steps.parse.outputs.beta_version }}"

          # Verify release exists and is a prerelease
          RELEASE_INFO=$(gh api "repos/${{ github.repository }}/releases/tags/$BETA_TAG" 2>/dev/null || echo "")

          if [ -z "$RELEASE_INFO" ]; then
            echo "::error::Release $BETA_TAG not found"
            exit 1
          fi

          IS_PRERELEASE=$(echo "$RELEASE_INFO" | jq -r '.prerelease')
          RELEASE_ID=$(echo "$RELEASE_INFO" | jq -r '.id')

          if [ "$IS_PRERELEASE" != "true" ]; then
            echo "::error::Release $BETA_TAG is not a prerelease"
            exit 1
          fi

          # Check for required assets
          ASSETS=$(echo "$RELEASE_INFO" | jq -r '.assets[].name')
          HAS_DMG=$(echo "$ASSETS" | grep -c '\.dmg$' || echo "0")
          HAS_EXE=$(echo "$ASSETS" | grep -c '\.exe$' || echo "0")
          HAS_DEB=$(echo "$ASSETS" | grep -c '\.deb$' || echo "0")

          if [ "$HAS_DMG" -eq 0 ] || [ "$HAS_EXE" -eq 0 ] || [ "$HAS_DEB" -eq 0 ]; then
            echo "::error::Beta release is missing required assets (DMG: $HAS_DMG, EXE: $HAS_EXE, DEB: $HAS_DEB)"
            exit 1
          fi

          echo "release_id=$RELEASE_ID" >> $GITHUB_OUTPUT
          echo "Beta release validated: $BETA_TAG (ID: $RELEASE_ID)"

      - name: "Check stable version doesn't exist"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          STABLE_TAG="v${{ steps.parse.outputs.stable_version }}"

          if gh api "repos/${{ github.repository }}/releases/tags/$STABLE_TAG" &>/dev/null; then
            echo "::error::Stable release $STABLE_TAG already exists"
            exit 1
          fi

          echo "Stable version $STABLE_TAG is available"

  # =============================================================================
  # Download and rename assets
  # =============================================================================
  prepare-assets:
    name: "Prepare Assets"
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: "Download beta assets"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p assets
          BETA_TAG="v${{ needs.validate.outputs.beta_version }}"

          echo "Downloading assets from $BETA_TAG..."

          gh release download "$BETA_TAG" --repo "${{ github.repository }}" --dir assets

          echo "Downloaded assets:"
          ls -la assets/

      - name: "Rename assets to stable version"
        env:
          BETA_VERSION: ${{ needs.validate.outputs.beta_version }}
          STABLE_VERSION: ${{ needs.validate.outputs.stable_version }}
        run: |
          cd assets

          echo "Renaming from $BETA_VERSION to $STABLE_VERSION..."

          for file in *; do
            if [ -f "$file" ]; then
              newname="${file//$BETA_VERSION/$STABLE_VERSION}"
              if [ "$file" != "$newname" ]; then
                echo "  $file -> $newname"
                mv "$file" "$newname"
              fi
            fi
          done

          echo "Renamed assets:"
          ls -la

      - name: "Upload renamed assets"
        uses: actions/upload-artifact@v4
        with:
          name: stable-assets
          path: assets/
          retention-days: 1

  # =============================================================================
  # Create stable release
  # =============================================================================
  create-release:
    name: "Create Release"
    needs: [validate, prepare-assets]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: "Setup Git"
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: "Download assets"
        uses: actions/download-artifact@v4
        with:
          name: stable-assets
          path: assets

      - name: "Update version in develop"
        env:
          STABLE_VERSION: ${{ needs.validate.outputs.stable_version }}
        run: |
          git checkout develop
          git pull origin develop

          # Update all package.json files
          npm version $STABLE_VERSION --no-git-tag-version
          for pkg in packages/app packages/backend packages/landing; do
            if [ -f "$pkg/package.json" ]; then
              cd "$pkg"
              npm version $STABLE_VERSION --no-git-tag-version
              cd - > /dev/null
            fi
          done

          git add package.json package-lock.json \
            packages/app/package.json \
            packages/backend/package.json \
            packages/landing/package.json
          git commit -m "chore(release): v$STABLE_VERSION"
          git push origin develop

      - name: "Create tag on develop"
        env:
          STABLE_VERSION: ${{ needs.validate.outputs.stable_version }}
        run: |
          git tag -a "v$STABLE_VERSION" -m "Release v$STABLE_VERSION"
          git push origin "v$STABLE_VERSION"

      - name: "Generate changelog"
        id: changelog
        env:
          BETA_TAG: v${{ needs.validate.outputs.beta_version }}
        run: |
          # Get the previous stable tag
          PREV_STABLE=$(git tag -l "v*" --sort=-version:refname | grep -v "beta" | head -2 | tail -1 || echo "")

          if [ -n "$PREV_STABLE" ]; then
            COMMITS=$(git log ${PREV_STABLE}..HEAD --pretty=format:"- %s (%h)" --no-merges | grep -v "^- chore(release)" | head -30)
          else
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges -20)
          fi

          # Categorize commits
          FEATURES=$(echo "$COMMITS" | grep -E "^- feat" || true)
          FIXES=$(echo "$COMMITS" | grep -E "^- fix" || true)
          OTHER=$(echo "$COMMITS" | grep -vE "^- (feat|fix)" | head -10 || true)

          {
            echo "changelog<<EOF"
            if [ -n "$FEATURES" ]; then
              echo "### New Features"
              echo "$FEATURES"
              echo ""
            fi
            if [ -n "$FIXES" ]; then
              echo "### Bug Fixes"
              echo "$FIXES"
              echo ""
            fi
            if [ -n "$OTHER" ]; then
              echo "### Other Changes"
              echo "$OTHER"
              echo ""
            fi
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: "Create GitHub Release"
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.validate.outputs.stable_version }}
          name: "v${{ needs.validate.outputs.stable_version }}"
          body: |
            ## Release v${{ needs.validate.outputs.stable_version }}

            ${{ steps.changelog.outputs.changelog }}

            ---

            ### Downloads

            | Platform | File |
            |----------|------|
            | macOS | `PR-Manager-${{ needs.validate.outputs.stable_version }}.dmg` |
            | Windows | `PRManager-${{ needs.validate.outputs.stable_version }}-Setup.exe` |
            | Linux | `pr-manager_${{ needs.validate.outputs.stable_version }}_amd64.deb` / `.rpm` |

            ---

            *Promoted from beta: v${{ needs.validate.outputs.beta_version }}*
          draft: false
          prerelease: false
          files: assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}

  # =============================================================================
  # Sync main branch
  # =============================================================================
  sync-main:
    name: "Sync Main"
    needs: [validate, create-release]
    if: inputs.sync_main
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: "Setup Git"
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: "Try fast-forward merge"
        id: merge
        continue-on-error: true
        run: |
          git fetch origin main develop
          git checkout main
          git merge origin/develop --ff-only
          git push origin main
          echo "merged=true" >> $GITHUB_OUTPUT
          echo "Main branch updated successfully via fast-forward"

      - name: "Create PR if merge failed"
        if: steps.merge.outputs.merged != 'true'
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
          STABLE_VERSION: ${{ needs.validate.outputs.stable_version }}
        run: |
          echo "::warning::Fast-forward merge failed, creating PR"

          # Check if PR already exists
          EXISTING_PR=$(gh pr list --base main --head develop --state open --json number -q '.[0].number' 2>/dev/null || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "PR #$EXISTING_PR already exists"
            echo "::warning::Please merge PR #$EXISTING_PR to sync main with develop"
          else
            PR_URL=$(gh pr create \
              --base main \
              --head develop \
              --title "chore: sync main with v$STABLE_VERSION" \
              --body "Auto-generated PR to sync main branch with develop after stable release v$STABLE_VERSION.

            Please resolve any conflicts and merge this PR to keep main in sync.")

            echo "Created PR: $PR_URL"
            echo "::warning::Created PR to sync main. Please resolve conflicts and merge."
          fi

  # =============================================================================
  # Deploy
  # =============================================================================
  deploy-backend:
    name: "Deploy Backend"
    needs: create-release
    uses: ./.github/workflows/deploy-backend.yml
    secrets: inherit

  deploy-landing:
    name: "Deploy Landing"
    needs: create-release
    uses: ./.github/workflows/deploy-landing.yml
    secrets: inherit

  # =============================================================================
  # Summary
  # =============================================================================
  summary:
    name: "Summary"
    needs: [validate, create-release, sync-main, deploy-backend, deploy-landing]
    if: always() && needs.create-release.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: "Generate summary"
        run: |
          echo "## Stable Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ needs.validate.outputs.stable_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Promoted from:** v${{ needs.validate.outputs.beta_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Release | Created |" >> $GITHUB_STEP_SUMMARY
          echo "| Main sync | ${{ needs.sync-main.result == 'success' && 'Synced' || 'PR created' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.deploy-backend.result == 'success' && 'Deployed' || 'Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Landing | ${{ needs.deploy-landing.result == 'success' && 'Deployed' || 'Skipped' }} |" >> $GITHUB_STEP_SUMMARY
