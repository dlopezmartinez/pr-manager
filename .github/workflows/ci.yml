name: "âœ… CI"

on:
  pull_request:
    branches: [develop, main]

# Permissions needed for dorny/paths-filter to read PR files
permissions:
  contents: read
  pull-requests: read

# Cancel in-progress runs for the same PR
concurrency:
  group: ci-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================
  # DETECT CHANGES - Determine what to test
  # ===========================================
  changes:
    name: "ğŸ” Detect Changes"
    runs-on: ubuntu-latest
    outputs:
      app: ${{ steps.filter.outputs.app }}
      backend: ${{ steps.filter.outputs.backend }}
      landing: ${{ steps.filter.outputs.landing }}
      deps: ${{ steps.filter.outputs.deps }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            app:
              - 'packages/app/**'
            backend:
              - 'packages/backend/**'
            landing:
              - 'packages/landing/**'
            deps:
              - 'package.json'
              - 'package-lock.json'

  # ===========================================
  # SECURITY - Always runs (quick check)
  # ===========================================
  security:
    name: "ğŸ”’ Security Audit"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: "ğŸ“— Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: "ğŸ“¦ Install dependencies"
        run: npm ci

      - name: "ğŸ”’ Check for critical vulnerabilities"
        run: |
          AUDIT_RESULT=$(npm audit --audit-level=critical --json 2>/dev/null || true)
          CRITICAL=$(echo "$AUDIT_RESULT" | jq -r '.metadata.vulnerabilities.critical // 0')

          if [ "$CRITICAL" -gt 0 ]; then
            echo "âŒ Found $CRITICAL critical vulnerabilities"
            exit 1
          fi
          echo "âœ… No critical vulnerabilities found"

  # ===========================================
  # APP - Only when packages/app changes
  # ===========================================
  lint-app:
    name: "ğŸ” Lint App"
    runs-on: ubuntu-latest
    needs: [changes, security]
    if: needs.changes.outputs.app == 'true' || needs.changes.outputs.deps == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: "ğŸ“— Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: "ğŸ“¦ Install dependencies"
        run: npm ci

      - name: "ğŸ” Run ESLint"
        working-directory: packages/app
        run: npm run lint

  test-app:
    name: "ğŸ§ª Test App"
    runs-on: ubuntu-latest
    needs: lint-app
    steps:
      - uses: actions/checkout@v4

      - name: "ğŸ“— Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: "ğŸ“¦ Install dependencies"
        run: npm ci

      - name: "ğŸ§ª Run tests"
        working-directory: packages/app
        run: npm run test

  # ===========================================
  # BACKEND - Only when packages/backend changes
  # ===========================================
  lint-backend:
    name: "ğŸ” Lint Backend"
    runs-on: ubuntu-latest
    needs: [changes, security]
    if: needs.changes.outputs.backend == 'true' || needs.changes.outputs.deps == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: "ğŸ“— Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: "ğŸ“¦ Install dependencies"
        run: npm ci

      - name: "ğŸ” Run ESLint"
        working-directory: packages/backend
        run: npm run lint

  test-backend:
    name: "ğŸ§ª Test Backend"
    runs-on: ubuntu-latest
    needs: lint-backend
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: pr_manager_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    steps:
      - uses: actions/checkout@v4

      - name: "ğŸ“— Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: "â³ Wait for PostgreSQL"
        run: until pg_isready -h localhost -p 5432 -U postgres; do sleep 1; done
        env:
          PGPASSWORD: postgres

      - name: "ğŸ“¦ Install dependencies"
        run: npm ci

      - name: "ğŸ”§ Generate Prisma Client"
        working-directory: packages/backend
        run: npx prisma generate
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/pr_manager_test?schema=public

      - name: "ğŸ—„ï¸ Run migrations"
        working-directory: packages/backend
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/pr_manager_test?schema=public

      - name: "ğŸ§ª Run tests"
        working-directory: packages/backend
        run: npm run test
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/pr_manager_test?schema=public
          JWT_SECRET: test-jwt-secret-key-for-testing-12345
          DOWNLOAD_SECRET: test-download-secret-for-testing-12345
          NODE_ENV: test

  # ===========================================
  # LANDING - Only when packages/landing changes
  # ===========================================
  build-landing:
    name: "ğŸ—ï¸ Build Landing"
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.landing == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: "ğŸ“— Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: "ğŸ“¦ Install dependencies"
        working-directory: packages/landing
        run: npm install

      - name: "ğŸ—ï¸ Build"
        working-directory: packages/landing
        run: npm run build

  # ===========================================
  # E2E - Only on PRs to main (expensive tests)
  # ===========================================
  test-e2e:
    name: "ğŸ­ E2E Tests"
    runs-on: ubuntu-latest
    needs: [test-app, test-backend]
    # Only run on PRs targeting main
    if: |
      github.base_ref == 'main' &&
      (needs.test-app.result == 'success' || needs.test-app.result == 'skipped') &&
      (needs.test-backend.result == 'success' || needs.test-backend.result == 'skipped')
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: pr_manager_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    steps:
      - uses: actions/checkout@v4

      - name: "ğŸ“— Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: "â³ Wait for PostgreSQL"
        run: until pg_isready -h localhost -p 5432 -U postgres; do sleep 1; done
        env:
          PGPASSWORD: postgres

      - name: "ğŸ“¦ Install dependencies"
        run: npm ci

      - name: "ğŸ”§ Generate Prisma Client"
        working-directory: packages/backend
        run: npx prisma generate
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/pr_manager_test?schema=public

      - name: "ğŸ—„ï¸ Run migrations"
        working-directory: packages/backend
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/pr_manager_test?schema=public

      - name: "ğŸ“¦ Install Playwright"
        run: npx playwright install --with-deps

      - name: "ğŸ­ Run E2E tests"
        run: npm run e2e
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/pr_manager_test?schema=public
          JWT_SECRET: test-jwt-secret-for-e2e-testing
          DOWNLOAD_SECRET: test-download-secret-for-e2e-testing
          NODE_ENV: test
          CI: true

      - name: "ğŸ“Š Upload report on failure"
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  # ===========================================
  # STATUS CHECK - For branch protection
  # ===========================================
  ci-status:
    name: "âœ… CI Status"
    runs-on: ubuntu-latest
    needs: [security, lint-app, test-app, lint-backend, test-backend, build-landing, test-e2e]
    if: always()
    steps:
      - name: "Check CI Status"
        run: |
          echo "Security: ${{ needs.security.result }}"
          echo "Lint App: ${{ needs.lint-app.result }}"
          echo "Test App: ${{ needs.test-app.result }}"
          echo "Lint Backend: ${{ needs.lint-backend.result }}"
          echo "Test Backend: ${{ needs.test-backend.result }}"
          echo "Build Landing: ${{ needs.build-landing.result }}"
          echo "E2E Tests: ${{ needs.test-e2e.result }}"

          # Fail if any required job failed (skipped is OK)
          if [[ "${{ needs.security.result }}" == "failure" ]]; then
            echo "âŒ Security check failed"
            exit 1
          fi

          if [[ "${{ needs.lint-app.result }}" == "failure" ]]; then
            echo "âŒ App lint failed"
            exit 1
          fi

          if [[ "${{ needs.test-app.result }}" == "failure" ]]; then
            echo "âŒ App tests failed"
            exit 1
          fi

          if [[ "${{ needs.lint-backend.result }}" == "failure" ]]; then
            echo "âŒ Backend lint failed"
            exit 1
          fi

          if [[ "${{ needs.test-backend.result }}" == "failure" ]]; then
            echo "âŒ Backend tests failed"
            exit 1
          fi

          if [[ "${{ needs.build-landing.result }}" == "failure" ]]; then
            echo "âŒ Landing build failed"
            exit 1
          fi

          if [[ "${{ needs.test-e2e.result }}" == "failure" ]]; then
            echo "âŒ E2E tests failed"
            exit 1
          fi

          echo "âœ… All CI checks passed!"
