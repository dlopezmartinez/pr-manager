name: "Release Beta (Simple)"

on:
  workflow_dispatch:
    inputs:
      skip_signing:
        description: "Skip code signing (for debugging)"
        required: false
        type: boolean
        default: false

concurrency:
  group: release-beta
  cancel-in-progress: false

permissions:
  contents: write
  actions: write

jobs:
  prepare:
    name: "Prepare"
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.new_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 10
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: "Calculate beta version"
        id: version
        run: |
          CURRENT=$(node -p "require('./package.json').version")

          if [[ "$CURRENT" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)(-([a-z]+)\.([0-9]+))?$ ]]; then
            MAJOR="${BASH_REMATCH[1]}"
            MINOR="${BASH_REMATCH[2]}"
            PATCH="${BASH_REMATCH[3]}"
            PRERELEASE_TYPE="${BASH_REMATCH[5]}"
            PRERELEASE_NUM="${BASH_REMATCH[6]}"
          else
            echo "::error::Invalid version format: $CURRENT"
            exit 1
          fi

          if [ -n "$PRERELEASE_TYPE" ] && [ "$PRERELEASE_TYPE" == "beta" ]; then
            NEW_NUM=$((PRERELEASE_NUM + 1))
            NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}-beta.${NEW_NUM}"
          else
            NEW_PATCH=$((PATCH + 1))
            NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}-beta.1"
          fi

          while git tag -l "v${NEW_VERSION}" | grep -q .; do
            if [[ "$NEW_VERSION" =~ ^(.+)-beta\.([0-9]+)$ ]]; then
              BASE="${BASH_REMATCH[1]}"
              NUM="${BASH_REMATCH[2]}"
              NEW_VERSION="${BASE}-beta.$((NUM + 1))"
            fi
          done

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Version: $CURRENT -> $NEW_VERSION"

  build-macos:
    name: "Build macOS"
    needs: prepare
    runs-on: macos-latest
    env:
      NEW_VERSION: ${{ needs.prepare.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: develop

      - name: "Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: "Install dependencies"
        run: npm ci

      - name: "Update version before build"
        run: |
          echo "Setting version to $NEW_VERSION"
          npm version $NEW_VERSION --no-git-tag-version --workspaces --include-workspace-root

      - name: "Build"
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
        run: |
          cd packages/app
          npm run make -- --platform darwin --arch arm64

      - name: "Upload artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: macos-artifacts
          path: |
            packages/app/out/make/*.dmg
            packages/app/out/make/zip/darwin/**/*.zip
          retention-days: 1

  build-windows:
    name: "Build Windows"
    needs: prepare
    runs-on: windows-latest
    env:
      NEW_VERSION: ${{ needs.prepare.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: develop

      - name: "Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: "Install dependencies"
        run: npm ci

      - name: "Update version before build"
        run: |
          echo "Setting version to $env:NEW_VERSION"
          npm version $env:NEW_VERSION --no-git-tag-version --workspaces --include-workspace-root

      - name: "Build"
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
        run: |
          cd packages/app
          npm run make -- --platform win32 --arch x64

      - name: "Upload artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            packages/app/out/make/squirrel.windows/**/*.exe
            packages/app/out/make/squirrel.windows/**/*.nupkg
            packages/app/out/make/squirrel.windows/**/RELEASES
          retention-days: 1

  build-linux:
    name: "Build Linux"
    needs: prepare
    runs-on: ubuntu-latest
    env:
      NEW_VERSION: ${{ needs.prepare.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: develop

      - name: "Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: "Install dependencies"
        run: npm ci

      - name: "Update version before build"
        run: |
          echo "Setting version to $NEW_VERSION"
          npm version $NEW_VERSION --no-git-tag-version --workspaces --include-workspace-root

      - name: "Build"
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
        run: |
          cd packages/app
          npm run make -- --platform linux --arch x64

      - name: "Upload artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: |
            packages/app/out/make/deb/x64/*.deb
            packages/app/out/make/rpm/x64/*.rpm
          retention-days: 1

  release:
    name: "Create Release"
    needs: [prepare, build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: "Setup Git"
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: "Update version"
        env:
          NEW_VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          npm version $NEW_VERSION --no-git-tag-version --workspaces --include-workspace-root

      - name: "Download all artifacts"
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: "Organize assets"
        run: |
          mkdir -p release-assets
          find artifacts -type f \( -name "*.dmg" -o -name "*.zip" -o -name "*.exe" -o -name "*.deb" -o -name "*.rpm" -o -name "*.nupkg" -o -name "RELEASES" \) -exec cp {} release-assets/ \;
          echo "Release assets:"
          ls -la release-assets/

      - name: "Commit version bump and tag"
        env:
          NEW_VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          # Only commit package.json files, NOT the binary artifacts
          git add package.json package-lock.json \
            packages/app/package.json \
            packages/backend/package.json \
            packages/landing/package.json
          git commit -m "chore(release): v$NEW_VERSION"
          git tag -a "v$NEW_VERSION" -m "Beta Release v$NEW_VERSION"
          git push origin develop
          git push origin "v$NEW_VERSION"

      - name: "Create Release"
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.prepare.outputs.version }}
          name: "v${{ needs.prepare.outputs.version }} (Beta)"
          body: |
            ## Beta Release v${{ needs.prepare.outputs.version }}

            This is a **pre-release** version for testing.

            ### Downloads

            | Platform | File |
            |----------|------|
            | macOS | `PR-Manager-${{ needs.prepare.outputs.version }}.dmg` |
            | Windows | `PRManager-${{ needs.prepare.outputs.version }}-Setup.exe` |
            | Linux | `pr-manager_${{ needs.prepare.outputs.version }}_amd64.deb` / `.rpm` |
          draft: false
          prerelease: true
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
