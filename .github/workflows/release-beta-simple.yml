name: "Release Beta (Simple)"

on:
  workflow_dispatch:
    inputs:
      skip_signing:
        description: "Skip code signing (for debugging)"
        required: false
        type: boolean
        default: false

concurrency:
  group: release-beta
  cancel-in-progress: false

permissions:
  contents: write
  actions: write

jobs:
  # ===========================================================================
  # Phase 1: Calculate version and update package.json files
  # ===========================================================================
  prepare-and-version:
    name: "Prepare & Update Version"
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.new_version }}
      commit_sha: ${{ steps.push.outputs.commit_sha }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 10
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: "Setup Git"
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: "Calculate beta version"
        id: version
        run: |
          CURRENT=$(node -p "require('./package.json').version")

          if [[ "$CURRENT" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)(-([a-z]+)\.([0-9]+))?$ ]]; then
            MAJOR="${BASH_REMATCH[1]}"
            MINOR="${BASH_REMATCH[2]}"
            PATCH="${BASH_REMATCH[3]}"
            PRERELEASE_TYPE="${BASH_REMATCH[5]}"
            PRERELEASE_NUM="${BASH_REMATCH[6]}"
          else
            echo "::error::Invalid version format: $CURRENT"
            exit 1
          fi

          if [ -n "$PRERELEASE_TYPE" ] && [ "$PRERELEASE_TYPE" == "beta" ]; then
            NEW_NUM=$((PRERELEASE_NUM + 1))
            NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}-beta.${NEW_NUM}"
          else
            NEW_PATCH=$((PATCH + 1))
            NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}-beta.1"
          fi

          while git tag -l "v${NEW_VERSION}" | grep -q .; do
            if [[ "$NEW_VERSION" =~ ^(.+)-beta\.([0-9]+)$ ]]; then
              BASE="${BASH_REMATCH[1]}"
              NUM="${BASH_REMATCH[2]}"
              NEW_VERSION="${BASE}-beta.$((NUM + 1))"
            fi
          done

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "Version: $CURRENT -> $NEW_VERSION"

      - name: "Update version in all packages"
        env:
          NEW_VERSION: ${{ steps.version.outputs.new_version }}
        run: |
          npm version $NEW_VERSION --no-git-tag-version --workspaces --include-workspace-root

      - name: "Commit and push version update"
        id: push
        env:
          NEW_VERSION: ${{ steps.version.outputs.new_version }}
        run: |
          git add package.json package-lock.json \
            packages/app/package.json \
            packages/backend/package.json \
            packages/landing/package.json
          git commit -m "chore(release): v$NEW_VERSION"
          git push origin develop

          COMMIT_SHA=$(git rev-parse HEAD)
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "Pushed version update: $COMMIT_SHA"

  # ===========================================================================
  # Phase 2: Build all platforms using the reusable workflow
  # ===========================================================================
  build:
    name: "Build"
    needs: prepare-and-version
    uses: ./.github/workflows/build-artifacts.yml
    with:
      ref: ${{ needs.prepare-and-version.outputs.commit_sha }}
      artifact-suffix: "-release"
      sign-macos: ${{ inputs.skip_signing != true }}
      sign-windows: ${{ inputs.skip_signing != true }}
    secrets: inherit

  # ===========================================================================
  # Phase 3: Create GitHub Release
  # ===========================================================================
  release:
    name: "Create Release"
    needs: [prepare-and-version, build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-and-version.outputs.commit_sha }}
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: "Setup Git"
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: "Create and push tag"
        env:
          NEW_VERSION: ${{ needs.prepare-and-version.outputs.version }}
        run: |
          git tag -a "v$NEW_VERSION" -m "Beta Release v$NEW_VERSION"
          git push origin "v$NEW_VERSION"

      - name: "Download all artifacts"
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: "Organize release assets"
        run: |
          mkdir -p release-assets

          # Find all release files
          find artifacts -type f \( \
            -name "*.dmg" -o \
            -name "*.zip" -o \
            -name "*.exe" -o \
            -name "*.deb" -o \
            -name "*.rpm" -o \
            -name "*.nupkg" -o \
            -name "RELEASES" \
          \) -exec cp {} release-assets/ \;

          echo "Release assets:"
          ls -la release-assets/

      - name: "Generate changelog"
        id: changelog
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges | grep -v "^- chore(release)" | head -20)
          else
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges -10 | grep -v "^- chore(release)")
          fi

          {
            echo "changelog<<EOF"
            echo "### Changes"
            if [ -n "$COMMITS" ]; then
              echo "$COMMITS"
            else
              echo "- Beta release"
            fi
            echo ""
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: "Create GitHub Release"
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.prepare-and-version.outputs.version }}
          name: "v${{ needs.prepare-and-version.outputs.version }} (Beta)"
          body: |
            ## Beta Release v${{ needs.prepare-and-version.outputs.version }}

            This is a **pre-release** version for testing.

            ${{ steps.changelog.outputs.changelog }}

            ---

            ### Downloads

            | Platform | File |
            |----------|------|
            | macOS | `PR-Manager-${{ needs.prepare-and-version.outputs.version }}.dmg` |
            | Windows | `PRManager-${{ needs.prepare-and-version.outputs.version }}-Setup.exe` |
            | Linux | `pr-manager_${{ needs.prepare-and-version.outputs.version }}_amd64.deb` / `.rpm` |

            ---

            *To promote this beta to stable, run the "Release Stable" workflow with this tag.*
          draft: false
          prerelease: true
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}

      - name: "Summary"
        run: |
          echo "## Beta Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ needs.prepare-and-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To promote this to stable, run the **Release Stable** workflow." >> $GITHUB_STEP_SUMMARY
